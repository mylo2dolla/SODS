Strange Vault ‚Äì Progress Update (LOCKED)

Status: Locked / Stable
Date: 2026-02-03
Scope: Vault ingest, events, devices, identifiers, CLI-first (no web dashboard)

‚∏ª

1. Architecture (Current, Locked)

Tier 0 ‚Äì Mac (Cockpit / CLI)
	‚Ä¢	CLI-driven inspection and control
	‚Ä¢	Direct queries against Vault API
	‚Ä¢	No UI coupling, no persistence here

Tier 1 ‚Äì Raspberry Pi (pi-aux)
	‚Ä¢	Sensor / scanner node
	‚Ä¢	Produces NDJSON BLE events
	‚Ä¢	Writes to /vault/inbox/pi-aux.events.ndjson
	‚Ä¢	Sends events via HTTP POST to Vault ingest

Tier 2 ‚Äì Raspberry Pi (pi-logger)
	‚Ä¢	Authoritative vault
	‚Ä¢	Runs ingest service (FastAPI + SQLite WAL)
	‚Ä¢	Append-only semantics
	‚Ä¢	Local-only, no cloud

‚∏ª

2. Vault Ingest Service

Service: strange-vault-ingest.service

Process:

/opt/strange/vault/venv/bin/uvicorn ingest:app \
  --app-dir /opt/strange/vault \
  --host 0.0.0.0 \
  --port 8088

Health:

GET /health
‚Üí { "ok": true, "db": "/vault/db/vault.sqlite" }

Status: systemd-managed, stable, auto-restart enabled

‚∏ª

3. Event Ingest (FINAL BEHAVIOR)

Accepted Input Schema (pi-aux NDJSON)

{
  "event_id": <int>,
  "ts_ms": <epoch_ms>,
  "type": "ble.seen",
  "src": "pi-aux",
  "data": { ... }
}

Normalization Rules (LOCKED)
	‚Ä¢	node_id ‚Üê payload.node_id || payload.src || payload.node.id || "unknown"
	‚Ä¢	kind ‚Üê payload.kind || payload.type || "unknown"
	‚Ä¢	event_ts ‚Üê payload.event_ts || payload.ts || ts_ms ‚Üí ISO8601
	‚Ä¢	summary ‚Üê payload.summary || kind
	‚Ä¢	data_json ‚Üê JSON(payload.data) or NULL
	‚Ä¢	raw_json ‚Üê full payload JSON

Resulting Stored Event

{
  node_id: "pi-aux",
  kind: "ble.seen",
  summary: "ble.seen",
  event_ts: "2026-02-03T12:05:32.133Z",
  data_json: { addr, rssi, flags, hci, ... }
}

Confirmed: No more unknown bleed-through for valid events

‚∏ª

4. Events API

List Events

GET /v1/events?node_id=pi-aux&limit=N

	‚Ä¢	Ordered newest ‚Üí oldest
	‚Ä¢	Limit capped at 500
	‚Ä¢	Used by CLI and analysis scripts

‚∏ª

5. Device Registry (NEW ‚Äì LOCKED)

Device Model
	‚Ä¢	Stable device_id (e.g. ble:37:c1:48:a5:3e:5c)
	‚Ä¢	One device may have multiple identifiers
	‚Ä¢	Devices updated automatically from events

Tables (Logical)
	‚Ä¢	devices
	‚Ä¢	device_id (PK)
	‚Ä¢	kind (ble)
	‚Ä¢	label (nullable)
	‚Ä¢	first_seen_ts
	‚Ä¢	last_seen_ts
	‚Ä¢	meta_json
	‚Ä¢	device_identifiers
	‚Ä¢	device_id (FK)
	‚Ä¢	id_type (ble_addr)
	‚Ä¢	id_value (MAC)
	‚Ä¢	first_seen_ts
	‚Ä¢	last_seen_ts
	‚Ä¢	source_node
	‚Ä¢	meta_json (addr_type, rssi, flags, hci)

‚∏ª

6. Devices API (LOCKED)

List Devices

GET /v1/devices?limit=5
GET /v1/devices?kind=ble
GET /v1/devices?q=37:c1:48:a5:3e:5c

Include Identifiers

GET /v1/devices?include_identifiers=true

Single Device

GET /v1/device/{device_id}

Confirmed Working:
	‚Ä¢	Discovery
	‚Ä¢	First/last seen tracking
	‚Ä¢	Identifier attachment
	‚Ä¢	Query by substring

‚∏ª

7. Data Integrity Notes
	‚Ä¢	SQLite in WAL mode
	‚Ä¢	Readers use RO mode or .timeout
	‚Ä¢	Ingest is append-only
	‚Ä¢	Historical events preserved even if device rotates identifiers

‚∏ª

8. What Is Explicitly Deferred
	‚Ä¢	Web dashboard
	‚Ä¢	Correlation UI
	‚Ä¢	ML / heuristics
	‚Ä¢	External sync

(All intentionally postponed)

‚∏ª

9. Current State Summary (Truth)
	‚Ä¢	‚úÖ Ingest works
	‚Ä¢	‚úÖ Events normalized
	‚Ä¢	‚úÖ Devices tracked
	‚Ä¢	‚úÖ Identifiers linked
	‚Ä¢	‚úÖ CLI-first workflow proven
	‚Ä¢	üîí Schema + behavior locked

This is a stable foundation. Any further work builds on top, not sideways.

‚∏ª

Next Logical Steps (Not Executed Yet):
	‚Ä¢	Monthly identifier refresh / enrichment script
	‚Ä¢	Labeling devices (manual or rules)
	‚Ä¢	Higher-level correlation (presence, dwell, motion)