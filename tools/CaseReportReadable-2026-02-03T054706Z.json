#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

APP="/Applications/Dev Station.app"
BUILD_LOG="${TMPDIR:-/tmp}/devstation-build.$(date +%Y%m%d-%H%M%S).log"

cd "$REPO_ROOT"

echo "==> Rebuilding Dev Station (log: $BUILD_LOG)"
if ! "$REPO_ROOT/tools/devstation-build.sh" 2>&1 | tee "$BUILD_LOG"; then
  echo
  echo "BUILD FAILED. Key errors:"
  grep -nE "error:|fatal error:|SwiftCompile|PiLoggerStore\.swift" "$BUILD_LOG" | tail -n 120 || true
  exit 1
fi

echo
echo "==> Installing Dev Station"
"$REPO_ROOT/tools/devstation-install.sh"

echo
echo "==> Launching Dev Station"
open "$APP"

echo
echo "OK: Dev Station rebuilt + installed + launched."