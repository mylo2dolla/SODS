#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
RUNNER="$REPO_ROOT/tools/_sods_cli.sh"

usage() {
  cat <<'USAGE'
devstation commands:
  devstation build      Build DevStation.app into dist/
  devstation run        Ensure station is running and launch app
  devstation rebuild    Clean + build + install + start station + launch app
  devstation up         Alias of rebuild
  devstation all        Alias of rebuild
  devstation install    Install dist/DevStation.app to /Applications
  devstation sods ...   Run raw SODS CLI command
  devstation ...        If unknown, falls through to SODS CLI
USAGE
}

cmd="${1:-}"
case "$cmd" in
  build)
    shift
    exec "$REPO_ROOT/tools/devstation-build.sh" "$@"
    ;;
  run)
    shift
    exec "$REPO_ROOT/tools/devstation-run.sh" "$@"
    ;;
  rebuild)
    shift
    exec "$REPO_ROOT/tools/devstation-rebuild.sh" "$@"
    ;;
  up|all)
    shift
    exec "$REPO_ROOT/tools/devstation-rebuild.sh" "$@"
    ;;
  install)
    shift
    exec "$REPO_ROOT/tools/devstation-install.sh" "$@"
    ;;
  sods)
    shift
    if [[ ! -x "$RUNNER" ]]; then
      echo "devstation: missing runner at $RUNNER" >&2
      exit 2
    fi
    exec "$RUNNER" "$@"
    ;;
  help|-h|--help)
    usage
    exit 0
    ;;
  *)
    if [[ ! -x "$RUNNER" ]]; then
      echo "devstation: missing runner at $RUNNER" >&2
      exit 2
    fi
    exec "$RUNNER" "$@"
    ;;
esac
